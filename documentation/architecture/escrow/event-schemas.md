# Event Schemas

Protobuf schema definitions for all Kafka events and commands in the escrow system.

## Implementation

The actual Protobuf schema files (`.proto`) are located in the `@bloxtr8/protobuf-schemas` package:

- **Package Location**: `packages/protobuf-schemas/`
- **Schema Files**: `packages/protobuf-schemas/schemas/`
  - `escrow-commands.proto` - Escrow command definitions
  - `escrow-events.proto` - Escrow event definitions
  - `payments-commands.proto` - Payment command definitions
  - `payments-events.proto` - Payment event definitions
  - `webhook-events.proto` - Webhook event definitions
  - `contracts-events.proto` - Contract event definitions

**TypeScript Types**: Generated TypeScript types are available from the package:

```typescript
import {
  CreateEscrow,
  EscrowCreated,
  PaymentSucceeded,
} from '@bloxtr8/protobuf-schemas';
```

See the [package README](../../../../packages/protobuf-schemas/README.md) for usage instructions and development guidelines.

## Schema Conventions

### Field Naming

- **snake_case** for field names (Protobuf convention)
- **PascalCase** for message types
- **required** fields: Essential business data
- **optional** fields: Metadata and tracing

### Standard Fields

All commands and events include:

- `event_id`: Unique identifier for idempotency (UUID)
- `trace_id`: Distributed tracing identifier (UUID)
- `correlation_id`: Request correlation identifier (UUID)
- `causation_id`: Parent event identifier (UUID)
- `occurred_at`: ISO 8601 timestamp
- `version`: Schema version string (e.g., "v1")

### Idempotency

All events include `event_id` generated deterministically from business state:

- Commands: Generated from request ID + escrow ID
- Events: Generated from business state + timestamp

## Escrow Commands

### CreateEscrow

Command to create a new escrow instance.

```protobuf
message CreateEscrow {
  string escrow_id = 1;              // CUID, generated by API Gateway
  string contract_id = 2;            // Contract that triggered escrow
  string buyer_id = 3;               // User ID of buyer
  string seller_id = 4;              // User ID of seller
  string currency = 5;               // "USD" | "USDC"
  int64 amount_cents = 6;            // Amount in cents (for USD) or smallest unit
  string network = 7;                // "BASE" (for USDC, empty for USD)
  string trace_id = 8;               // Distributed tracing ID
  string causation_id = 9;           // ContractExecuted event ID
  string correlation_id = 10;        // Request correlation ID
  string version = 11;               // "v1"
}
```

**Validation**:

- `escrow_id`: Required, unique, CUID format
- `contract_id`: Required, must exist
- `buyer_id` != `seller_id`
- `amount_cents` > 0
- `currency`: Must be "USD" or "USDC"
- If `currency` == "USDC", `network` must be "BASE"

### MarkDelivered

Command to mark escrow as delivered by seller.

```protobuf
message MarkDelivered {
  string escrow_id = 1;              // Escrow to mark as delivered
  string actor_id = 2;               // User ID of seller (must match escrow.seller_id)
  string event_id = 3;               // Unique event ID for idempotency
  string trace_id = 4;               // Distributed tracing ID
  string causation_id = 5;           // API request ID
  string correlation_id = 6;         // Request correlation ID
  string version = 7;                // "v1"
}
```

**Validation**:

- `escrow_id`: Required, must exist
- `actor_id`: Must match escrow.seller_id
- Escrow status must be `FUNDS_HELD`

### ReleaseFunds

Command to release funds to seller.

```protobuf
message ReleaseFunds {
  string escrow_id = 1;              // Escrow to release
  string actor_id = 2;               // User ID of buyer (must match escrow.buyer_id)
  string event_id = 3;               // Unique event ID for idempotency
  string trace_id = 4;               // Distributed tracing ID
  string causation_id = 5;           // API request ID
  string correlation_id = 6;         // Request correlation ID
  string version = 7;                // "v1"
}
```

**Validation**:

- `escrow_id`: Required, must exist
- `actor_id`: Must match escrow.buyer_id
- Escrow status must be `DELIVERED`

### CancelEscrow

Command to cancel escrow (timeout or manual cancellation).

```protobuf
message CancelEscrow {
  string escrow_id = 1;              // Escrow to cancel
  string reason = 2;                 // "TIMEOUT" | "BUYER_CANCELLED" | "SELLER_CANCELLED" | "ADMIN"
  string actor_id = 3;               // User ID of canceller (empty for TIMEOUT)
  string event_id = 4;               // Unique event ID
  string trace_id = 5;               // Distributed tracing ID
  string causation_id = 6;           // Triggering event ID
  string correlation_id = 7;         // Request correlation ID
  string version = 8;                // "v1"
}
```

**Validation**:

- `escrow_id`: Required
- `reason`: Required, must be valid enum value
- Escrow status must not be `RELEASED` or `REFUNDED`

### RaiseDispute

Command to raise a dispute on an escrow.

```protobuf
message RaiseDispute {
  string escrow_id = 1;              // Escrow to dispute
  string actor_id = 2;               // Buyer or seller user ID
  string reason = 3;                 // Dispute reason/description
  string event_id = 4;               // Unique event ID for idempotency
  string trace_id = 5;               // Distributed tracing ID
  string causation_id = 6;           // API request ID
  string correlation_id = 7;         // Request correlation ID
  string version = 8;                // "v1"
}
```

**Validation**:

- `escrow_id`: Required, must exist
- `actor_id`: Must be buyer or seller
- Escrow status must be `FUNDS_HELD` or `DELIVERED`

### ResolveDispute

Command to resolve a dispute (admin only).

```protobuf
message ResolveDispute {
  string escrow_id = 1;              // Escrow to resolve
  string actor_id = 2;               // Admin user ID
  string resolution = 3;             // "RELEASE" | "REFUND"
  string reason = 4;                 // Resolution reason
  string event_id = 5;               // Unique event ID for idempotency
  string trace_id = 6;               // Distributed tracing ID
  string causation_id = 7;           // Triggering event ID
  string correlation_id = 8;         // Request correlation ID
  string version = 9;                // "v1"
}
```

**Validation**:

- `escrow_id`: Required, must exist
- `actor_id`: Must be admin user
- `resolution`: Required, must be "RELEASE" or "REFUND"
- Escrow status must be `DISPUTED`

### EscrowCreated

Emitted when escrow is created.

```protobuf
message EscrowCreated {
  string escrow_id = 1;
  string contract_id = 2;
  string buyer_id = 3;
  string seller_id = 4;
  string currency = 5;
  int64 amount_cents = 6;
  string network = 7;
  string event_id = 8;
  string occurred_at = 9;           // ISO 8601 timestamp
  string version = 10;               // "v1"
}
```

### EscrowAwaitFunds

Emitted when escrow is waiting for payment.

```protobuf
message EscrowAwaitFunds {
  string escrow_id = 1;
  string event_id = 2;
  string occurred_at = 3;
  string version = 4;
}
```

### EscrowFundsHeld

Emitted when payment is received and funds are held.

```protobuf
message EscrowFundsHeld {
  string escrow_id = 1;
  string provider = 2;               // "stripe" | "custodian"
  string provider_payment_id = 3;    // Stripe payment_intent ID or custodian tx hash
  int64 amount_cents = 4;
  string currency = 5;
  string event_id = 6;
  string occurred_at = 7;
  string causation_id = 8;           // PaymentSucceeded event ID
  string version = 9;
}
```

### EscrowDelivered

Emitted when seller marks escrow as delivered.

```protobuf
message EscrowDelivered {
  string escrow_id = 1;
  string actor_id = 2;               // Seller user ID
  string event_id = 3;
  string occurred_at = 4;
  string causation_id = 5;           // MarkDelivered command ID
  string version = 6;
}
```

### EscrowReleased

Emitted when funds are released to seller.

```protobuf
message EscrowReleased {
  string escrow_id = 1;
  string provider = 2;               // "stripe" | "custodian"
  string transfer_id = 3;            // Stripe transfer ID or custodian tx hash
  string event_id = 4;
  string occurred_at = 5;
  string causation_id = 6;           // TransferSucceeded event ID
  string version = 7;
}
```

### EscrowCancelled

Emitted when escrow is cancelled.

```protobuf
message EscrowCancelled {
  string escrow_id = 1;
  string reason = 2;                 // Cancellation reason
  string actor_id = 3;               // User ID (empty for timeout)
  string event_id = 4;
  string occurred_at = 5;
  string causation_id = 6;
  string version = 7;
}
```

### EscrowRefunded

Emitted when funds are refunded to buyer.

```protobuf
message EscrowRefunded {
  string escrow_id = 1;
  string provider = 2;               // "stripe" | "custodian"
  string refund_id = 3;              // Provider refund ID
  string reason = 4;                 // Refund reason
  string event_id = 5;
  string occurred_at = 6;
  string causation_id = 7;           // RefundSucceeded event ID
  string version = 8;
}
```

### EscrowDisputed

Emitted when a dispute is raised on an escrow.

```protobuf
message EscrowDisputed {
  string escrow_id = 1;
  string actor_id = 2;               // User who raised dispute
  string reason = 3;                 // Dispute reason
  string event_id = 4;
  string occurred_at = 5;
  string causation_id = 6;           // RaiseDispute command ID
  string version = 7;
}
```

## Payment Commands

### CreatePaymentIntent

Command to create payment intent (Stripe or custodian deposit address).

```protobuf
message CreatePaymentIntent {
  string escrow_id = 1;
  string provider = 2;               // "stripe" | "custodian"
  string currency = 3;               // "USD" | "USDC"
  int64 amount_cents = 4;
  string network = 5;                // "BASE" (for custodian, empty for Stripe)
  string trace_id = 6;
  string causation_id = 7;           // EscrowCreated event ID
  string correlation_id = 8;
  string version = 9;
}
```

**Validation**:

- `escrow_id`: Required, must exist
- `provider`: Must match escrow rail (STRIPE → "stripe", USDC_BASE → "custodian")
- `amount_cents`: Must match escrow amount

### TransferToSeller

Command to transfer funds to seller.

```protobuf
message TransferToSeller {
  string escrow_id = 1;
  string seller_account_id = 2;      // Stripe account ID or custodian wallet address
  string provider = 3;               // "stripe" | "custodian"
  string trace_id = 4;
  string causation_id = 5;           // EscrowDelivered event ID
  string correlation_id = 6;
  string version = 7;
}
```

**Validation**:

- `escrow_id`: Required, status must be `DELIVERED`
- `seller_account_id`: Required, format validated by provider

### InitiateRefund

Command to initiate refund to buyer.

```protobuf
message InitiateRefund {
  string escrow_id = 1;
  string reason = 2;                 // Refund reason
  string trace_id = 3;
  string causation_id = 4;           // Cancellation or dispute event ID
  string correlation_id = 5;
  string version = 6;
}
```

### CancelPayment

Command to cancel a payment intent.

```protobuf
message CancelPayment {
  string escrow_id = 1;
  string reason = 2;                 // Cancellation reason
  string trace_id = 3;
  string causation_id = 4;           // Triggering event ID
  string correlation_id = 5;
  string version = 6;
}
```

## Payment Events

### PaymentIntentCreated

Emitted when payment intent is created.

```protobuf
message PaymentIntentCreated {
  string escrow_id = 1;
  string provider = 2;               // "stripe" | "custodian"
  string provider_payment_id = 3;    // Stripe payment_intent ID or custodian address
  string client_secret = 4;          // Stripe client secret (empty for custodian)
  string deposit_address = 5;        // Custodian deposit address (empty for Stripe)
  string event_id = 6;
  string occurred_at = 7;
  string causation_id = 8;           // CreatePaymentIntent command ID
  string version = 9;
}
```

### PaymentSucceeded

Emitted when payment is successfully received.

```protobuf
message PaymentSucceeded {
  string escrow_id = 1;
  string provider = 2;               // "stripe" | "custodian"
  string provider_payment_id = 3;     // Stripe payment_intent ID or custodian tx hash
  int64 amount_cents = 4;
  string currency = 5;
  string event_id = 6;
  string occurred_at = 7;
  string causation_id = 8;           // Webhook event ID
  string version = 9;
}
```

### PaymentFailed

Emitted when payment fails.

```protobuf
message PaymentFailed {
  string escrow_id = 1;
  string provider = 2;
  string provider_payment_id = 3;
  string error_code = 4;             // Provider error code
  string error_message = 5;          // Human-readable error
  string event_id = 6;
  string occurred_at = 7;
  string causation_id = 8;
  string version = 9;
}
```

### TransferSucceeded

Emitted when funds are successfully transferred to seller.

```protobuf
message TransferSucceeded {
  string escrow_id = 1;
  string provider = 2;               // "stripe" | "custodian"
  string transfer_id = 3;            // Stripe transfer ID or custodian tx hash
  string event_id = 4;
  string occurred_at = 5;
  string causation_id = 6;           // TransferToSeller command ID
  string version = 7;
}
```

### TransferFailed

Emitted when transfer fails.

```protobuf
message TransferFailed {
  string escrow_id = 1;
  string provider = 2;
  string error_code = 3;
  string error_message = 4;
  string event_id = 5;
  string occurred_at = 6;
  string causation_id = 7;
  string version = 8;
}
```

### RefundSucceeded

Emitted when refund is successfully processed.

```protobuf
message RefundSucceeded {
  string escrow_id = 1;
  string provider = 2;
  string refund_id = 3;              // Provider refund ID
  int64 amount_cents = 4;
  string event_id = 5;
  string occurred_at = 6;
  string causation_id = 7;           // InitiateRefund command ID
  string version = 8;
}
```

### RefundFailed

Emitted when refund fails.

```protobuf
message RefundFailed {
  string escrow_id = 1;
  string provider = 2;
  string error_code = 3;
  string error_message = 4;
  string event_id = 5;
  string occurred_at = 6;
  string causation_id = 7;
  string version = 8;
}
```

## Webhook Events

### StripeWebhookValidated

Emitted after Stripe webhook signature verification.

```protobuf
message StripeWebhookValidated {
  string webhook_event_id = 1;       // Stripe event ID
  string event_type = 2;            // "payment_intent.succeeded", etc.
  string payment_intent_id = 3;     // Stripe payment_intent ID
  string escrow_id = 4;              // Extracted from metadata
  map<string, string> raw_data = 5; // Key fields from webhook (no PII)
  string event_id = 6;
  string occurred_at = 7;
  string version = 8;
}
```

### CustodianWebhookValidated

Emitted after custodian webhook signature verification.

```protobuf
message CustodianWebhookValidated {
  string webhook_event_id = 1;       // Custodian event ID
  string event_type = 2;            // "deposit.confirmed", "transfer.completed"
  string transaction_hash = 3;      // Blockchain transaction hash
  string escrow_id = 4;              // Extracted from metadata
  string sender_address = 5;         // Wallet address (for screening)
  string amount = 6;                 // Amount as string (for precision)
  string currency = 7;              // "USDC"
  string network = 8;               // "BASE"
  string event_id = 9;
  string occurred_at = 10;
  string version = 11;
}
```

## Contract Events

### ContractExecuted

Emitted when contract is fully executed (both parties signed).

```protobuf
message ContractExecuted {
  string contract_id = 1;
  string buyer_id = 2;
  string seller_id = 3;
  string listing_id = 4;
  string offer_id = 5;
  string event_id = 6;
  string occurred_at = 7;
  string version = 8;
}
```

### ContractVoided

Emitted when contract is voided (expired or cancelled).

```protobuf
message ContractVoided {
  string contract_id = 1;
  string reason = 2;                 // "EXPIRED" | "CANCELLED"
  string event_id = 3;
  string occurred_at = 4;
  string version = 5;
}
```

## Schema Evolution

### Backward Compatibility Rules

1. **Add Optional Fields**: Always safe (old consumers ignore)
2. **Remove Fields**: Mark as deprecated, remove after migration period
3. **Rename Fields**: Not supported (use new field, deprecate old)
4. **Change Field Types**: Not supported (requires new version)

### Versioning Strategy

- **Minor Changes**: Same version (backward compatible)
- **Breaking Changes**: New version (e.g., `v2`)

### Migration Example

```
v1: CreateEscrow { escrow_id, contract_id, buyer_id, seller_id }
v2: CreateEscrow { escrow_id, contract_id, buyer_id, seller_id, metadata }

Producers: Emit both v1 and v2 during transition
Consumers: Handle both versions
Deprecation: Remove v1 after all consumers upgraded
```

## Schema Registry Configuration

- **Format**: Protobuf
- **Compatibility**: BACKWARD (new consumers read old events)
- **Validation**: Strict schema validation on publish
- **Evolution**: Manual approval for breaking changes

## Related Documentation

- [Protobuf Schemas Package](../../../../packages/protobuf-schemas/README.md) - Package documentation and usage
- [Topic Catalog](./topic-catalog.md) - Topic inventory and partitioning
- [Escrow System Architecture](./escrow-system-architecture.md) - Architecture overview
- [State Machine](./state-machine.md) - State transitions and validation
