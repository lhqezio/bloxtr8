// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
  moduleFormat = "esm"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x", "linux-musl-arm64-openssl-3.0.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL_PRISMA")
}

model User {
  id          String   @id @default(cuid())
  discordId   String   @unique
  username    String
  email       String?
  phone       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // KYC tiers
  kycTier     KycTier  @default(TIER_1)
  kycVerified Boolean  @default(false)
  
  // Wallet screening
  walletAddress String?
  walletRisk   WalletRisk @default(UNKNOWN)
  
  // Relations
  listings    Listing[]
  buyerOffers Offer[] @relation("BuyerOffers")
  sellerOffers Offer[] @relation("SellerOffers")
  signatures  Signature[]
  auditLogs   AuditLog[]
  deliveries  Delivery[]
  disputes    Dispute[] @relation("DisputeUser")
  guildMemberships GuildMember[]
  
  @@index([discordId])
  @@index([email])
  @@index([walletAddress])
  @@map("users")
}

model Guild {
  id          String   @id @default(cuid())
  discordId   String   @unique
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  members     GuildMember[]
  listings    Listing[]
  
  @@index([discordId])
  @@map("guilds")
}

model GuildMember {
  id        String   @id @default(cuid())
  role      GuildRole @default(MEMBER)
  joinedAt  DateTime @default(now())
  
  // Relations
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  guildId   String
  guild     Guild    @relation(fields: [guildId], references: [id])
  
  @@unique([userId, guildId])
  @@index([userId])
  @@index([guildId])
  @@map("guild_members")
}

model Listing {
  id          String      @id @default(cuid())
  title       String
  summary     String
  price       Int         // Price in cents
  category    String
  status      ListingStatus @default(ACTIVE)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  // Relations
  userId      String
  user        User        @relation(fields: [userId], references: [id])
  guildId     String?
  guild       Guild?      @relation(fields: [guildId], references: [id])
  offers      Offer[]
  robloxSnapshots RobloxSnapshot[]
  deliveries  Delivery[]
  
  @@index([userId])
  @@index([guildId])
  @@index([status])
  @@index([category])
  @@map("listings")
}

model Offer {
  id          String      @id @default(cuid())
  amount      Int         // Amount in cents
  currency    Currency    @default(USD)
  conditions  String?
  expiry      DateTime
  status      OfferStatus @default(PENDING)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  // Relations
  listingId   String
  listing     Listing     @relation(fields: [listingId], references: [id])
  buyerId     String
  buyer       User        @relation("BuyerOffers", fields: [buyerId], references: [id])
  sellerId    String
  seller      User        @relation("SellerOffers", fields: [sellerId], references: [id])
  
  // Parent offer for counter offers
  parentId    String?
  parent      Offer?      @relation("OfferCounter", fields: [parentId], references: [id])
  counters    Offer[]     @relation("OfferCounter")
  
  contracts   Contract[]
  escrows     Escrow[]
  deliveries  Delivery[]
  
  @@index([listingId])
  @@index([buyerId])
  @@index([sellerId])
  @@index([status])
  @@index([expiry])
  @@map("offers")
}

model Contract {
  id          String          @id @default(cuid())
  pdfUrl      String?
  sha256      String?
  status      ContractStatus  @default(PENDING_SIGNATURE)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  
  // Relations
  offerId     String
  offer       Offer           @relation(fields: [offerId], references: [id])
  signatures  Signature[]
  escrows     Escrow[]
  deliveries  Delivery[]
  
  @@index([offerId])
  @@index([status])
  @@map("contracts")
}

model Signature {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  contractId  String
  contract    Contract @relation(fields: [contractId], references: [id])
  signedAt    DateTime @default(now())
  
  @@unique([userId, contractId])
  @@index([userId])
  @@index([contractId])
  @@map("signatures")
}

model Escrow {
  id          String      @id @default(cuid())
  rail        EscrowRail
  amount      Int         // Amount in cents
  currency    Currency    @default(USD)
  status      EscrowStatus @default(AWAIT_FUNDS)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  // Relations
  offerId     String
  offer       Offer       @relation(fields: [offerId], references: [id])
  contractId  String
  contract    Contract    @relation(fields: [contractId], references: [id])
  
  // Rail-specific data
  stripeEscrow      StripeEscrow?
  stablecoinEscrow  StablecoinEscrow?
  milestoneEscrow   MilestoneEscrow[]
  
  auditLogs   AuditLog[]
  deliveries  Delivery[]
  disputes    Dispute[]
  
  @@index([offerId])
  @@index([contractId])
  @@index([status])
  @@index([rail])
  @@map("escrows")
}

model StripeEscrow {
  id              String  @id @default(cuid())
  paymentIntentId String  @unique
  transferId      String?
  refundId        String?
  
  escrowId        String  @unique
  escrow          Escrow  @relation(fields: [escrowId], references: [id])
  
  @@map("stripe_escrows")
}

model StablecoinEscrow {
  id          String  @id @default(cuid())
  chain       String  @default("BASE")
  depositAddr String
  depositTx   String?
  releaseTx   String?
  
  escrowId    String  @unique
  escrow      Escrow  @relation(fields: [escrowId], references: [id])
  
  @@map("stablecoin_escrows")
}

model MilestoneEscrow {
  id          String      @id @default(cuid())
  title       String
  amountCents Int
  status      EscrowStatus @default(AWAIT_FUNDS)
  
  escrowId    String
  escrow      Escrow      @relation(fields: [escrowId], references: [id])
  
  @@index([escrowId])
  @@map("milestone_escrows")
}

model Delivery {
  id          String        @id @default(cuid())
  title       String
  description String?
  status      DeliveryStatus @default(PENDING)
  deliveredAt DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  // Relations
  listingId   String
  listing     Listing       @relation(fields: [listingId], references: [id])
  offerId     String
  offer       Offer         @relation(fields: [offerId], references: [id])
  contractId  String
  contract    Contract      @relation(fields: [contractId], references: [id])
  escrowId    String
  escrow      Escrow        @relation(fields: [escrowId], references: [id])
  deliveredBy String
  deliveredByUser User      @relation(fields: [deliveredBy], references: [id])
  
  @@index([listingId])
  @@index([offerId])
  @@index([contractId])
  @@index([escrowId])
  @@index([deliveredBy])
  @@index([status])
  @@map("deliveries")
}

model Dispute {
  id          String      @id @default(cuid())
  title       String
  description String
  status      DisputeStatus @default(OPEN)
  resolution  String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  resolvedAt  DateTime?
  
  // Relations
  escrowId    String
  escrow      Escrow      @relation(fields: [escrowId], references: [id])
  userId      String
  user        User        @relation("DisputeUser", fields: [userId], references: [id])
  
  @@index([escrowId])
  @@index([userId])
  @@index([status])
  @@map("disputes")
}

model RobloxSnapshot {
  id          String   @id @default(cuid())
  groupId     String
  owner       String
  memberCount Int
  metadata    Json?
  createdAt   DateTime @default(now())
  
  // Relations
  listingId   String?
  listing     Listing?  @relation(fields: [listingId], references: [id])
  
  @@index([listingId])
  @@index([groupId])
  @@map("roblox_snapshots")
}

model AuditLog {
  id          String   @id @default(cuid())
  action      String
  details     Json?
  createdAt   DateTime @default(now())
  
  // Relations
  userId      String?
  user        User?    @relation(fields: [userId], references: [id])
  escrowId    String?
  escrow      Escrow?  @relation(fields: [escrowId], references: [id])
  
  @@index([userId])
  @@index([escrowId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

model WebhookEvent {
  id          String   @id @default(cuid())
  eventId     String   @unique
  provider    String   // 'stripe', 'custodian', etc.
  processed   Boolean  @default(false)
  createdAt   DateTime @default(now())
  
  @@index([eventId])
  @@index([provider])
  @@index([processed])
  @@map("webhook_events")
}

// Enums
enum KycTier {
  TIER_1
  TIER_2
}

enum WalletRisk {
  UNKNOWN
  LOW
  MEDIUM
  HIGH
  SANCTIONED
}

enum ListingStatus {
  ACTIVE
  INACTIVE
  SOLD
}

enum OfferStatus {
  PENDING
  ACCEPTED
  COUNTERED
  DECLINED
  EXPIRED
}

enum ContractStatus {
  PENDING_SIGNATURE
  EXECUTED
  VOID
}

enum EscrowRail {
  STRIPE
  USDC_BASE
}

enum EscrowStatus {
  AWAIT_FUNDS
  FUNDS_HELD
  DELIVERED
  RELEASED
  DISPUTED
  REFUNDED
  CANCELLED
}

enum Currency {
  USD
  USDC
}

enum GuildRole {
  MEMBER
  MODERATOR
  ADMIN
  OWNER
}

enum DeliveryStatus {
  PENDING
  IN_PROGRESS
  DELIVERED
  CONFIRMED
  REJECTED
}

enum DisputeStatus {
  OPEN
  IN_REVIEW
  RESOLVED
  CLOSED
}
